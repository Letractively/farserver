<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>System Admin</title>

<link rel="stylesheet" type="text/css" href="../js/easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../js/easyui/themes/icon.css">
<script type="text/javascript" src="../js/jquery-1.4.2.min.js"></script>
<script language="Javascript" type="text/javascript" src="../js/easyui/jquery.easyui.min.js"></script>


<script type="text/javascript">


var roles = null;

$(document).ready(function(){

	$.ajax(
			{
				type: 'post',
			 	url:"../service/admin/role/list",
			 	data:{},
			 	dataType:"json",
			 	success:function(data) {
					roles = data;
			 	}
			}
	);


	
	$('#rolecfg').click(
			function() {
				var editIndex = -1;
				$('#main').html($('#roleDiv').html());
    			$('#roleTable').datagrid({
    				toolbar:[
    		    		{
        		    		text:"新增",
        		    		iconCls:'icon-add',
        		    		handler:function(){
									$('#roleTable').datagrid('endEdit', editIndex);
    								$('#roleTable').datagrid('appendRow',{
	    								name:'',
	    								open:'false',
	    								contentSize:'1000',
	    								totalSize:'100000',
	    								enabled:'true'
    								});
    								editIndex = $('#roleTable').datagrid('getRows').length-1;
    								$('#roleTable').datagrid('beginEdit', editIndex);
    						}
        				},'-',
        				{
        		    		text:"修改",
        		    		iconCls:'icon-edit',
        		    		handler:function(){
        						var rowIndex = $('#roleTable').datagrid('getRowIndex', $('#roleTable').datagrid('getSelected'));
	        					if (editIndex != rowIndex){
	    							$('#roleTable').datagrid('cancelEdit', editIndex);
	    							$('#roleTable').datagrid('beginEdit', rowIndex);
	    						}
	        					editIndex = rowIndex;
    						}
        				},'-',
        				
        				{
        					text:'保存',
        					iconCls:'icon-save',
        					handler:function(){
        						$('#roleTable').datagrid("endEdit", editIndex);
        						editIndex = -1;
        					}
        				},'-',{
    					text:'删除',
    					iconCls:'icon-remove',
    					handler:function(){
    						var row = $('#roleTable').datagrid('getSelected');
    						if (row){

    							$.messager.confirm('删除角色', '当心，删除角色会使角色下的用户不可用，是否确认删除？', function(r){
    								if (r){
		    							var index = $('#roleTable').datagrid('getRowIndex', row);
		    							$.post("../service/admin/role/remove", 
		    	    							{id:row.id},
		    	    							function(data) {
					    							$('#roleTable').datagrid('deleteRow', index);
		    	    					});
    								}
    							});
    				    							
        						
    						}
    					}
    				}],
    				
    				onClickRow:function(rowIndex){
						if (editIndex != rowIndex){
							$('#roleTable').datagrid('cancelEdit', editIndex);
							editIndex = -1;
						}
					},
					onAfterEdit: function(rowIndex, rowData, changes) {
						
						$.post("../service/admin/role/save", 
								rowData,
								function(data){
									if (data!="OK") {
										$.messager.alert('My Title',data,'error');
									}
	        						$('#roleTable').datagrid('reload');
								}
						);
					}
    			});
			}
	);		




	$('#usercfg').click(
			function() {
				var editIndex = -1;
				$('#main').html($('#userDiv').html());
				$('#userTable').datagrid({
					toolbar:[
		    		    		{
		        		    		text:"新增",
		        		    		iconCls:'icon-add',
		        		    		handler:function(){
											$('#userTable').datagrid('endEdit', editIndex);
		    								$('#userTable').datagrid('appendRow',{
			    								name:'',
			    								email:'',
			    								role:'',
			    								password:'123456',
			    								disabled:'false'
		    								});
		    								editIndex = $('#userTable').datagrid('getRows').length-1;
		    								$('#userTable').datagrid('beginEdit', editIndex);
		    						}
		        				},'-',
		        				{
		        		    		text:"修改",
		        		    		iconCls:'icon-edit',
		        		    		handler:function(){
		        						var rowIndex = $('#userTable').datagrid('getRowIndex', $('#userTable').datagrid('getSelected'));
			        					if (editIndex != rowIndex){
			    							$('#userTable').datagrid('cancelEdit', editIndex);
			    							$('#userTable').datagrid('beginEdit', rowIndex);
			    						}
			        					editIndex = rowIndex;
		    						}
		        				},'-',
		        				{
		        					text:'保存',
		        					iconCls:'icon-save',
		        					handler:function(){
		        						$('#userTable').datagrid("endEdit", editIndex);
		        						editIndex = -1;
		        					}
		        				}, "-",
		        				{
		        					text:'应用',
		        					iconCls:'icon-print',
		        					handler:function(data){
		        						var rowIndex = $('#userTable').datagrid('getRowIndex', $('#userTable').datagrid('getSelected'));
		        						if (rowIndex>-1) {
		        							var userName = $('#userTable').datagrid('getData').rows[rowIndex].name;
		        							$.getJSON("../service/admin/user/apps", 
				        							{"username":userName},
				        							function(data) {
					        							var ul_element = $('#listInfo');
					        							var shtml = '';
					        							for(var i=0; i<data.length; i++) {
						        							shtml += '<li><a href="/user/' + userName + '/' + data[i] + '/">' + data[i] + '</a></li>';
					        							}
					        							ul_element.html(shtml);
					        							//ul.html("ccdd");
				        							});
		        						}
		        						//$('#userTable').datagrid("endEdit", editIndex);
		        						//editIndex = -1;
		        					}
		        				}, "-",
		        				{
		        					text:'导入',
		        					iconCls:'icon-cut',
		        					handler:function(){
		        						$('#main').html($('#importUserDiv').html());
		        					}
		        				}
		    				],
		    				onClickRow:function(rowIndex){
								if (editIndex != rowIndex){
									$('#userTable').datagrid('cancelEdit', editIndex);
									editIndex = -1;
								}
							},
							
							onAfterEdit: function(rowIndex, rowData, changes) {
								$.post("../service/admin/user/save", 
										rowData,
										function(data){
			        						$('#userTable').datagrid('reload');
										}
								);
							},
							
							onBeforeEdit: function(rowIndex, rowData) {
								if (rowData.name=="") {
									$('#userTable').datagrid('getColumnOption', 'name').editor="text";
								} else {
									$('#userTable').datagrid('getColumnOption', 'name').editor=null;
								}
							},
							pagination:true
				});
			}
	)	






	$('#appscfg').click(
			function() {
				var editIndex = -1;
				$('#main').html($('#applistDiv').html());
				$('#appTable').datagrid({
					toolbar:[
						{
							text:'重新加载',
							iconCls:'icon-print',
							handler:function(data){
								var rowIndex = $('#appTable').datagrid('getRowIndex', $('#appTable').datagrid('getSelected'));
								if (rowIndex>-1) {
									var appName = $('#appTable').datagrid('getData').rows[rowIndex].name;
									$.getJSON("../service/admin/application/clean", 
											{"name":appName},
											function(data) {
												alert(data);
											});
								}
							}
						}
							
					],
					pagination:false
				});
			}
	)	





	

	

	
});

function userRoleNameFormator(value){
	for(var i=0; i<roles.rows.length; i++){
		if (roles.rows[i].id == value) return roles.rows[i].name;
	}
	return value;
}


function userApplicationsFormator(value){
	return '<span style="color:red">Edit Delete</span>';
}



function importUser() {
	$.post("../service/admin/user/import", 
			{
			"data":$('#importUserText').val(),
			"role":$('#importUserRole').val()
			},
			function(data) {
				alert(data);
			}
	);
}
</script>
</head>

<body class="easyui-layout">
		<div region="west" split="true" title="&nbsp;" style="width:300px;">
			<a href="../logout">退出</a>
			<ul>
				<LI><a id="servercfg" href="#">概要</a></LI>
				<li><a id="rolecfg" href="#" >角色</a></li>
				<li><a id="usercfg" href="#" >用户</a></li>
				<LI><a id="appscfg" href="#">应用</a></LI>
				<LI><a href="#">服务器日志</a></LI>
			</ul>
		</div>
		<!-- 
		<div id="console" region="south" icon="icon-cancel" split="true" title="日志" style="height:200px;padding:5px;background:white" >
					
		</div>
		 -->
		<div region="center" id="main">
		</div>
	
		<div region="east" split="true" title="&nbsp;" style="width:120px;padding:10px;">
			<ul id="listInfo">
			</ul>
		</div>
	
	
		<div style="display:none" id="roleDiv">
			<table id="roleTable" style="width:800px;height:auto;"
			title="角色管理" iconCls="icon-edit" singleSelect="true"
			idField="id" url="../service/admin/role/list">
			<thead>
				<tr>
					<th field="id" width="100">ID</th>
					<th field="name" width="200" editor="text">角色名称</th>
					<th field="open" width="100" align="right" editor="{type:'checkbox',options:{on:true,off:false}}">允许免费注册</th>
					<th field="contentSize" width="100" align="right" editor="numberbox">单文件限制(M)</th>
					<th field="totalSize" width="100" editor="numberbox">总空间限制(M)</th>
					<th field="enabled" width="100" align="center" editor="{type:'checkbox',options:{on:true,off:false}}">启用</th>
				</tr>
			</thead>
			</table>
		</div>
		
		<div style="display:none" id="userDiv">
			<div>
			<table id="userTable" style="width:800px;height:auto;"
			title="用户管理" iconCls="icon-edit" singleSelect="true"
			 url="../service/admin/user/list">
			<thead>
				<tr>
					<th field="name" width="100" sortable="true">用户名</th>
					<th field="email" width="200" editor="text">电子邮件</th>
					<th field="logined" width="50" sortable="true">登录次数</th>
					<th field="password" width="50" editor="text">密码</th>
					<th field="role" width="200" sortable="true" formatter="userRoleNameFormator" editor="{type:'combobox',options:{valueField:'id',textField:'name',data:roles.rows,required:true}}">角色</th>
					<th field="disabled" width="100" align="right" editor="{type:'checkbox',options:{on:true,off:false}}">禁用</th>
				</tr>
			</thead>
			</table>
			</div>
	    </div>
		
		
		<div style="display:none" id="importUserDiv">
			角色
			<input name="role" id="importUserRole"><br>
			列表
			<textarea rows="20" cols="100" id="importUserText"></textarea>
			<br>
			<a href="#" onclick="importUser()">导入</a>
		</div>			
			
			
			
		<div style="display:none" id="applistDiv">
			<table id="appTable" style="width:800px;height:auto;"
			title="安装的应用" iconCls="icon-edit" singleSelect="true"
			idField="name" url="../service/admin/application/list">
			<thead>
				<tr>
					<th field="name" width="100" sortable="true">应用名称</th>
					<th field="alias" width="200" editor="text">别名</th>
					<th field="owner" width="100" editor="text">开发人员</th>
					<th field="installed" width="300" sortable="true">安装次数</th>
				</tr>
			</thead>
			</table>
	    </div>
</body>
</html>
