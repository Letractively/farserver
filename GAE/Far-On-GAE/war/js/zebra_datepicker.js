(function(a){a.Zebra_DatePicker=function(fb,mb){var P="block",db=' class="',X=" dp_current",W=" dp_disabled",E="</td>",O="</tr><tr>",D="M",C="l",x="D",N=".dp_next",cb=".dp_caption",F="years",w="months",M="dp_blocked",L=".dp_previous",V="dp_hover",K="</tr>",J="<tr>",f="",q="none",n="display",B="days",l=true,p=false,lb={days:["日","一","二","三","四","五","六"],direction:0,disabled_dates:p,first_day_of_week:1,format:"Y-m-d",months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],offset:[10,-5],readonly_element:l,show_week_number:p,view:B,weekend_days:[0,6]},m,g,v,t,s,z,A,R,I,ab,d,e,o,k,c,Z,T,Y,S,G,h,H,b=this;b.settings={};var Q=a(fb),ob=function(){var G="td:not(.dp_disabled)",E="td:not(.dp_disabled, .dp_weekend_disabled, .dp_not_in_month, .dp_blocked, .dp_week_number)",C="click",D="readonly";b.settings=a.extend({},lb,mb);b.settings.readonly_element&&Q.attr(D,D);m=b.settings.view;var O='<button type="button" class="Zebra_DatePicker_Icon">Pick a date</button>';v=a(O);b.icon=v;h=!a.isArray(b.settings.direction)&&(b.settings.direction===l||j(b.settings.direction)>0)||a.isArray(b.settings.direction)&&b.settings.direction.length==2&&(b.settings.direction[0]===l||j(b.settings.direction[0])>0)?l:!a.isArray(b.settings.direction)&&(b.settings.direction===p||j(b.settings.direction)<0)||a.isArray(b.settings.direction)&&b.settings.direction.length==2&&(b.settings.direction[0]===p||j(b.settings.direction[0])<0)?p:0;var x=new Date;d=x.getMonth();R=x.getMonth();e=x.getFullYear();I=x.getFullYear();o=x.getDate();ab=x.getDate();if(h!==0){x=new Date(e,d,o+j(a.isArray(b.settings.direction)?b.settings.direction[0]:b.settings.direction));d=x.getMonth();e=x.getFullYear();o=x.getDate()}if(h!==0&&a.isArray(b.settings.direction)&&b.settings.direction.length==2){x=new Date(e,d,o+(h>0?1:-1)*j(b.settings.direction[1]));H=j(r(x.getFullYear(),i(x.getMonth(),2),i(x.getDate(),2)))}if(u(r(e,i(d,2),i(o,2)))){while(u(e)){if(!h)e--;else e++;d=0}while(u(r(e,i(d,2)))){if(!h)d--;else d++;if(d>11){e++;d=0}else if(d<0){e--;d=0}o=1}while(u(r(e,i(d,2),i(o,2)))){if(!h)o--;else o++;x=new Date(e,d,o);e=x.getFullYear();d=x.getMonth();o=x.getDate()}}(b.settings.readonly_element?v.add(Q):v).bind(C,function(f){f.preventDefault();if(g.css(n)!=q)b.hide();else{var a=kb(Q.val());if(a){T=a.getMonth();k=a.getMonth();Y=a.getFullYear();c=a.getFullYear();Z=a.getDate();if(u(r(Y,i(T,2),i(Z,2)))){k=d;c=e}}else{k=d;c=e}y();b.show()}});v.insertAfter(fb);var O=f+'<div class="Zebra_DatePicker"><table class="dp_header">'+J+'<td class="dp_previous">&laquo;</td><td class="dp_caption">&nbsp;</td><td class="dp_next">&raquo;</td>'+K+'</table><table class="dp_daypicker"></table><table class="dp_monthpicker"></table><table class="dp_yearpicker"></table></div>';g=a(O);b.datepicker=g;t=g.find("table.dp_header").first();s=g.find("table.dp_daypicker").first();z=g.find("table.dp_monthpicker").first();A=g.find("table.dp_yearpicker").first();a("body").append(g);g.delegate(E,"mouseover",function(){a(this).addClass(V)}).delegate(E,"mouseout",function(){a(this).removeClass(V)});hb(t.find("td"));t.find(L).bind(C,function(){if(!a(this).hasClass(M)){if(m==w)c--;else if(m==F)c-=12;else if(--k<0){k=11;c--}y()}});t.find(cb).bind(C,function(){if(m==B)m=w;else if(m==w)m=F;else m=B;y()});t.find(N).bind(C,function(){if(!a(this).hasClass(M)){if(m==w)c++;else if(m==F)c+=12;else if(++k==12){k=0;c++}y()}});s.delegate("td:not(.dp_disabled, .dp_weekend_disabled, .dp_not_in_month, .dp_week_number)",C,function(){Q.val(nb(new Date(c,k,j(a(this).html()))));b.hide()});z.delegate(G,C,function(){var b=a(this).attr("class").match(/dp\_month\_([0-9]+)/);k=j(b[1]);m=B;y()});A.delegate(G,C,function(){c=j(a(this).html());m=w;y()});a(document).bind({mousedown:b._mousedown,keyup:b._keyup});S=[]};b.hide=function(){eb("hide");g.css(n,q)};b.show=function(){y();var i=g.outerWidth(),h=g.outerHeight(),c=v.offset().left+b.settings.offset[0],d=v.offset().top-h+b.settings.offset[1],k=a(window).width(),j=a(window).height(),f=a(window).scrollTop(),e=a(window).scrollLeft();if(c+i>e+k)c=e+k-i;if(c<e)c=e;if(d+h>f+j)d=f+j-h;if(d<f)d=f;g.css({left:c,top:d});g.fadeIn(a.browser.msie&&a.browser.version.match(/^[6-8]/)?0:150,"linear");eb()};var kb=function(t){if(a.trim(t)!=f){for(var i=jb(b.settings.format.replace(/\s/g,f)),n=["d",x,"j",C,"N","S","w","F","m",D,"n","Y","y"],d=[],c=[],m=0;m<n.length;m++)(position=i.indexOf(n[m]))>-1&&d.push({character:n[m],position:position});d.sort(function(a,b){return a.position-b.position});a.each(d,function(d,b){var a="[a-z]{3}";switch(b.character){case"d":c.push("0[1-9]|[12][0-9]|3[01]");break;case x:c.push(a);break;case"j":c.push("[1-9]|[12][0-9]|3[01]");break;case C:c.push("[a-z]+");break;case"N":c.push("[1-7]");break;case"S":c.push("st|nd|rd|th");break;case"w":c.push("[0-6]");break;case"F":c.push("[a-z]+");break;case"m":c.push("0[1-9]|1[012]+");break;case D:c.push(a);break;case"n":c.push("[1-9]|1[012]");break;case"Y":c.push("[0-9]{4}");break;case"y":c.push("[0-9]{2}")}});if(c.length){d.reverse();a.each(d,function(a,b){i=i.replace(b.character,"("+c[c.length-a-1]+")")});c=new RegExp("^"+i+"$","ig");if(segments=c.exec(t.replace(/\s/g,f))){var o,e,h,s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],r=["January","February","March","April","May","June","July","August","September","October","November","December"],q,g=l;d.reverse();a.each(d,function(c,d){if(!g)return l;switch(d.character){case"m":case"n":e=j(segments[c+1]);break;case"d":case"j":o=j(segments[c+1]);break;case x:case C:case"F":case D:if(d.character==x||d.character==C)q=b.settings.days;else q=b.settings.months;g=p;a.each(q,function(a,b){if(g)return l;if(segments[c+1].toLowerCase()==b.substring(0,d.character==x||d.character==D?3:b.length).toLowerCase()){switch(d.character){case x:segments[c+1]=s[a].substring(0,3);break;case C:segments[c+1]=s[a];break;case"F":segments[c+1]=r[a];e=a+1;break;case D:segments[c+1]=r[a].substring(0,3);e=a+1}g=l}});break;case"Y":h=j(segments[c+1]);break;case"y":h="19"+j(segments[c+1])}});if(g){var k=new Date(h,e-1,o);if(k.getFullYear()==h&&k.getDate()==o&&k.getMonth()==e-1)return k}}}return p}},hb=function(b){if(a.browser.mozilla)b.css("MozUserSelect",q);else if(a.browser.msie)b.bind("selectstart",function(){return p});else b.mousedown(function(){return p})},jb=function(a){return a.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")},nb=function(d){for(var a=f,c=d.getDate(),k=d.getDay(),j=b.settings.days[k],e=d.getMonth()+1,g=b.settings.months[e-1],l=d.getFullYear()+f,h=0;h<b.settings.format.length;h++){var m=b.settings.format.charAt(h);switch(m){case"y":l=l.substr(2);case"Y":a+=l;break;case"m":e=i(e,2);case"n":a+=e;break;case D:g=g.substr(0,3);case"F":a+=g;break;case"d":c=i(c,2);case"j":a+=c;break;case x:j=j.substr(0,3);case C:a+=j;break;case"N":k++;case"w":a+=k;break;case"S":if(c%10==1&&c!="11")a+="st";else if(c%10==2&&c!="12")a+="nd";else if(c%10==3&&c!="13")a+="rd";else a+="th";break;default:a+=m}}return a},bb=function(){var o='<td class="dp_not_in_month">',m=new Date(c,k+1,0).getDate(),x=new Date(c,k,1).getDay(),t=new Date(c,k,0).getDate(),g=x-b.settings.first_day_of_week;g=g<0?7+g:g;U(b.settings.months[k]+", "+c);var e=J;if(b.settings.show_week_number)e+="<th>"+b.settings.show_week_number+"</th>";for(var d=0;d<7;d++)e+="<th>"+b.settings.days[(b.settings.first_day_of_week+d)%7].substr(0,2)+"</th>";e+=O;for(var d=0;d<42;d++){if(d>0&&d%7==0)e+=O;if(d%7==0&&b.settings.show_week_number){var v=new Date(c,0,1),p=new Date(c,k,d),w=Math.ceil(((p-v)/864e5+p.getDay()+1)/7);e+='<td class="dp_week_number">'+w+E}var h=d-g+1;if(d<g)e+=o+(t-g+d+1)+E;else if(h>m)e+=o+(h-m)+E;else{var q=(b.settings.first_day_of_week+d)%7,l=j(r(c,i(k,2),i(h,2)));class_name=f;if(u(l)||undefined!=H&&(b.settings.direction[0]>0&&l>H||b.settings.direction[0]<=0&&l<H))if(a.inArray(q,b.settings.weekend_days)>-1)class_name="dp_weekend_disabled";else class_name+=W;else{if(a.inArray(q,b.settings.weekend_days)>-1)class_name="dp_weekend";if(k==T&&c==Y&&Z==h)class_name+=" dp_selected";else if(k==R&&c==I&&ab==h)class_name+=X}e+="<td"+(class_name!=f?db+a.trim(class_name)+'"':f)+">"+i(h,2)+E}}e+=K;s.html(a(e));s.css(n,f)},gb=function(){U(c);for(var e=J,d=0;d<12;d++){if(d>0&&d%3==0)e+=O;var g="dp_month_"+d,h=j(r(c,i(d,2)));if(u(h))g+=W;else if(R==d&&I==c)g+=X;e+='<td class="'+a.trim(g)+'">'+b.settings.months[d].substr(0,3)+E}e+=K;z.html(a(e));z.css(n,f)},ib=function(){U(c-7+" - "+(c+4));for(var e=J,b=0;b<12;b++){if(b>0&&b%3==0)e+=O;var d=f,g=j(c-7+b);if(u(g))d+=W;else if(I==c-7+b)d+=X;e+="<td"+(a.trim(d)!=f?db+a.trim(d)+'"':f)+">"+(c-7+b)+E}e+=K;A.html(a(e));A.css(n,f)},eb=function(c){if(a.browser.msie&&a.browser.version.match(/^6/)){if(!G){var d=j(g.css("zIndex"))-1;G=jQuery("<iframe>",{src:'javascript:document.write("")',scrolling:"no",frameborder:0,allowtransparency:"true",css:{zIndex:d,position:"absolute",top:-1e3,left:-1e3,width:g.outerWidth(),height:g.outerHeight(),filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)",display:q}});a("body").append(G)}switch(c){case"hide":G.css(n,q);break;default:var b=g.offset();G.css({top:b.top,left:b.left,display:P})}}},u=function(b){if(h!==0){var m=(b+f).length;if(m==8&&(h&&b<r(e,i(d,2),i(o,2))||!h&&b>r(e,i(d,2),i(o,2))))return l;else if(m==6&&(h&&b<r(e,i(d,2))||!h&&b>r(e,i(d,2))))return l;else if(m==4&&(h&&b<e||!h&&b>e))return l}if(S){b=b+f;var n=j(b.substr(0,4)),g=j(b.substr(4,2))+1,k=j(b.substr(6,2)),c=p;a.each(S,function(){if(c)return;var b=this;if(a.inArray(n,b[2])>-1||a.inArray("*",b[2])>-1)if(undefined!=g&&a.inArray(g,b[1])>-1||a.inArray("*",b[1])>-1)if(undefined!=k&&a.inArray(k,b[0])>-1||a.inArray("*",b[0])>-1){if(b[3]=="*")return c=l;var d=new Date(n,g-1,k).getDay();if(a.inArray(d,b[3])>-1)return c=l}});if(c)return l}return p},U=function(e){t.find(cb).html(e);if(h!==0){var a=c,b=k,d;if(m==B){if(h&&--b<0){b=11;a--}else if(!h&&++b>11){b=0;a++}d=r(a,i(b,2))}else if(m==w){if(h)a--;else a++;d=a}else if(m==F){if(h)a-=7;else a+=7;d=a}if(u(d)){t.find(h?L:N).addClass(M);t.find(h?L:N).removeClass(V)}else t.find(h?L:N).removeClass(M)}},y=function(){if(s.text()==f||m==B){if(s.text()==f){g.css({left:-1e3,display:P});bb();var a=s.outerWidth(),b=s.outerHeight();t.css("width",a);z.css({width:a,height:b});A.css({width:a,height:b});g.css({display:q})}else bb();z.css(n,q);A.css(n,q)}else if(m==w){gb();s.css(n,q);A.css(n,q)}else if(m==F){ib();s.css(n,q);z.css(n,q)}},i=function(a,b){a+=f;while(a.length<b)a="0"+a;return a},r=function(){for(var b=f,a=0;a<arguments.length;a++)b+=arguments[a]+f;return b},j=function(a){return parseInt(a===l||a===p?0:a,10)};b._keyup=function(a){(g.css(n)==P||a.which==27)&&b.hide();return l};b._mousedown=function(c){if(g.css(n)==P){if(a(c.target).get(0)===v.get(0))return l;a(c.target).parents().filter(".Zebra_DatePicker").length==0&&b.hide()}return l};ob()};a.fn.Zebra_DatePicker=function(b){return this.each(function(){var e="Zebra_DatePicker",d=this;if(undefined!=a(d).data(e)){var c=a(d).data(e);c.icon.remove();c.datepicker.remove();a(document).unbind("keyup",c._keyup);a(document).unbind("mousedown",c._mousedown)}var c=new a.Zebra_DatePicker(d,b);a(d).data(e,c)})}})(jQuery);